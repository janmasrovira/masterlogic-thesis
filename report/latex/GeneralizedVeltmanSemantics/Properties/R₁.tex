\begin{spverbatim}
module GeneralizedVeltmanSemantics.Properties.Râ‚ where

open import Function.Equivalence using (_â‡”_; equivalence; module Equivalence)

open import Agda.Builtin.Nat using (Nat; suc; zero)
open import Agda.Builtin.Unit using (âŠ¤; tt)
open import Agda.Primitive using (Level; lzero; lsuc)
open import Data.Empty using (âŠ¥; âŠ¥-elim)
open import Data.Product renaming (_,_ to _â¸´_)
open import Data.Sum using (_âŠ_; injâ‚; injâ‚‚; [_,_])
open import Function using (_âˆ˜_; const; case_of_; id)
open import Function.Equality using (_âŸ¨$âŸ©_)
open import Relation.Binary using (REL; Rel; Transitive)
open import Relation.Nullary using (yes; no; Â¬_)
open import Relation.Unary using (Pred; _âˆˆ_; _âˆ‰_; Decidable; Satisfiable; _âŠ†_; _âˆ©_; ï½›_ï½)
open import Relation.Binary using (Irreflexive) renaming (Decidable to Decidableâ‚‚)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; subst; trans; sym)

open import Formula
open import GeneralizedVeltmanSemantics
open import Base using (_â‡’_; _â‡_; Decidableâ‚ƒ)
open import GeneralizedVeltmanSemantics.Properties
  using (module Extended; âŠ©Â¬; âŠ®Â¬; âŠ©â–¡; âŠ©â™¢; âŠ©MP; âŠ©âˆ§; âŠ©â†’Â¬âŠ®)
import Principles as P
open import GeneralizedFrame using (module Predicates)

private
  variable
    â„“W â„“R â„“S : Level

Râ‚-condition : âˆ€ {W R S} â†’ FrameL {lzero} {lzero} {lzero} W R S â†’ Set _
Râ‚-condition {W = W} {R = R} {S = S} F =
  âˆ€ {w x u V C ğ”¼} â†’ R w x â†’ R x u â†’ S w u V â†’ IsChoiceSet C x u
  â†’ âˆƒ[ V' ] (V' âŠ† V Ã— S w x V' Ã— R[ V' ] âŠ† C Ã—
    (âˆ€ {v c} â†’ v âˆˆ V' â†’ c âˆˆ C â†’ (âˆƒ[ U ] (U âŠ† Râ»Â¹ x [ ğ”¼ ] Ã— R v c Ã— S x c U))
    â†’ (âˆƒ[ ğ”¼' ] (ğ”¼' âŠ† ğ”¼ Ã— S v c ğ”¼'))))
  where open FrameL F
        open Predicates F

module Râ‚-soundness
  {W R S V}
  {M : Model {lzero} {lzero} {lzero} W R S V}
  (M,_*âŠ©?_ : MultiDecidableModel M)
  (âˆˆS? : Decidableâ‚ƒ S)
  (S? : S-decidable (Model.F M))
  (âˆˆSV? : âˆ€ {w u Y} â†’ S w u Y â†’ Decidable Y) where

  open Model M
  open FrameL F
  open Extended M,_*âŠ©?_ âˆˆS? âˆˆSV?

  âŠ©Râ‚ : âˆ€ {w A B C E D} â†’ S-decidable F â†’ Râ‚-condition F
    â†’ M , w âŠ© A â–· B â† (A â— C âˆ§ D â–· â™¢ E) â–· (B âˆ§ â–¡ C âˆ§ D â–· E)
  âŠ©Râ‚ {w} {A} {B} {C} {E} S-dec c = âŠ©â† â‡ Î» Aâ–·B â†’ âŠ©â–· â‡ Î» {x} Rwx t â†’ case âŠ©âˆ§ â‡’ t of
    Î» { (t1 â¸´ Dâ–·â™¢E) â†’ case âŠ©Â¬ â‡’ t1 of Î» { (rhd (u â¸´ Rxu â¸´ uA â¸´ Aâ—C))
    â†’ case (âŠ©â–· â‡’ Aâ–·B) (R-trans Rwx Rxu) uA of Î» { (V â¸´ SwuV â¸´ VB) â†’
    case Swu-sat SwuV of Î» { (_ â¸´ _) â†’
    case c {ğ”¼ = Î“} Rwx Rxu SwuV (ğ’ x u Aâ—C Rxu)
    of Î» { (V' â¸´ V'âŠ†V â¸´ SwxV' â¸´ R[V']âŠ†Î“ â¸´ cond) â†’ V' â¸´ (SwxV' â¸´ Î» { {v'} v'âˆˆV'
    â†’ âŠ©âˆ§ â‡ (VB (V'âŠ†V v'âˆˆV') â¸´ (âŠ©âˆ§ â‡ (âŠ©â–¡ â‡ (Î» {h} Rv'h â†’
    case âˆˆK x u h  â‡’ (R[V']âŠ†Î“ (v' â¸´ v'âˆˆV' â¸´ Rv'h)) of
    Î» { (_ â¸´ _ â¸´ _ â¸´ hC) â†’ hC})
    â¸´ âŠ©â–· â‡ Î» { {c} Rv'c cD â†’ let câˆˆÎ“ = R[V']âŠ†Î“ (v' â¸´ v'âˆˆV' â¸´ Rv'c) in
    case (âŠ©â–· â‡’ Dâ–·â™¢E) (KâŠ†Rx x u câˆˆÎ“) cD
    of Î» { (U â¸´ SxcU â¸´ Uâ™¢E) â†’ case cond v'âˆˆV' câˆˆÎ“ (U â¸´ (Î» {u} uU â†’ case âŠ©â™¢ â‡’ Uâ™¢E uU of
    Î» { (e â¸´ Ru'e â¸´ eâŠ©E) â†’ (e â¸´ (inE â‡ eâŠ©E â¸´ Ru'e)) â¸´ SwuYâŠ†Rw SxcU uU }) â¸´ Rv'c â¸´ SxcU) of
      Î» { (Î“' â¸´ Î“'âŠ†Î“ â¸´ Sv'cÎ“') â†’ Î“' â¸´ Sv'cÎ“' â¸´ Î» { {e} z â†’ inE â‡’ Î“'âŠ†Î“ z}}}})))})}}}}}
    where
      Î“ : ğ•
      Î“ = [âŠ© E ]
      inE : âˆ€ {e} â†’ e âˆˆ Î“ â‡” (M , e âŠ© E )
      inE = âˆˆ[âŠ© E ]
      K : (x u : W) â†’ ğ•
      K x u y with S-dec x u y
      ... | injâ‚‚ _ = âŠ¥
      ... | injâ‚ _ with M, y âŠ©? C
      ... | injâ‚ _ = âŠ¤
      ... | injâ‚‚ _ = âŠ¥
      âˆˆK : (x u y : W) â†’ y âˆˆ K x u â‡” Î£ ğ• Î» Z â†’ y âˆˆ Z Ã— S x u Z Ã— M , y âŠ© C
      âˆˆK x u y = equivalence â‡¨ â‡¦
        where
        â‡¨ : y âˆˆ K x u â†’ Î£ ğ• Î» Z â†’ y âˆˆ Z Ã— S x u Z Ã— M , y âŠ© C
        â‡¨ _ with S-dec x u y
        ... | injâ‚ (Y â¸´ yY â¸´ SxuY) with M, y âŠ©? C
        ... | injâ‚ x = Y â¸´ yY â¸´ SxuY â¸´ x
        â‡¦ : (Î£ ğ• Î» Z â†’ y âˆˆ Z Ã— S x u Z Ã— M , y âŠ© C) â†’ y âˆˆ K x u
        â‡¦ (Z â¸´ yâˆˆZ â¸´ SxuZ â¸´ yC) with S-dec x u y
        ... | injâ‚‚ p = p Z SxuZ yâˆˆZ
        ... | injâ‚ p with M, y âŠ©? C
        ... | injâ‚ _ = tt
        ... | injâ‚‚ p' = âŠ©â†’Â¬âŠ® yC p'
      KâŠ†Rx : (x u : W) â†’ K x u âŠ† R x
      KâŠ†Rx x u {z} zâˆˆÎ“ = case âˆˆK x u z â‡’ zâˆˆÎ“ of Î» { (Z â¸´ zâˆˆZ â¸´ SxuZ â¸´ _) â†’ SwuYâŠ†Rw SxuZ zâˆˆZ}
      ğ’ : (x u : W)
        â†’ ((Y : W â†’ Set) â†’ Satisfiable Y â†’ Â¬ S x u Y âŠ Satisfiable (Y âˆ© (M ,_âŠ® Â¬' C)))
          â†’ R x u â†’ IsChoiceSet (K x u) x u
      ğ’ x u s Rxu = Rxu â¸´ (Î» {Y} SxuY â†’ case s Y (Swu-sat SxuY) of
        Î» { (injâ‚ x) â†’ âŠ¥-elim (x SxuY) ; (injâ‚‚ (c â¸´ câˆˆY â¸´ câŠ©C)) â†’ c â¸´ câˆˆY â¸´
        âˆˆK x u c â‡ (Y â¸´ câˆˆY â¸´ SxuY â¸´ âŠ®Â¬ â‡’ câŠ©C)})


module Râ‚-completeness
  {W R S}
  {F : FrameL {lzero} {lzero} {lzero} W R S}
  (âˆˆS? : Decidableâ‚ƒ S)
  (dec : âˆ€ V â†’ MultiDecidableModel (model {V = V} F))
  (âˆˆSV? : âˆ€ {w u Y} â†’ S w u Y â†’ Decidable Y)
  where
  open FrameL F
  open Predicates F

  *âŠ©Râ‚ : Setâ‚
  *âŠ©Râ‚ = P.Râ‚ (F *âŠ©_)

  pattern a = 0
  pattern b = 1
  pattern c = 2
  pattern d = 3
  pattern e = 4

  Â¬Râ‚-condition : Set _
  Â¬Râ‚-condition = Î£ W Î» w â†’ Î£ W Î» x â†’ Î£ W Î» u â†’ Î£ ğ• Î» V â†’ Î£ ğ• Î» C â†’ Î£ ğ• Î» E â†’
    R w x Ã— R x u Ã— S w u V Ã— IsChoiceSet C x u Ã— E âŠ† R x Ã—
      let ğ’± U = U âŠ† V Ã— S w x U Ã— R[ U ] âŠ† C in
      Î£ (âˆ€ {V' : ğ•} â†’ V' âˆˆ ğ’± â†’ Î£ W Î» váµ¤ â†’ Î£ W Î» cáµ¤ â†’ Î£ ğ• Î» Záµ¤
      â†’ váµ¤ âˆˆ V' Ã— cáµ¤ âˆˆ C Ã— R váµ¤ cáµ¤ Ã— Záµ¤ âŠ† Râ»Â¹ x [ E ] Ã— S x cáµ¤ Záµ¤
        Ã— (âˆ€ ğ”¼' â†’ ğ”¼' âŠ† E â†’ Â¬ S váµ¤ cáµ¤ ğ”¼'))
        Î» p â†’
      let âˆˆğ’±â‡’ : âˆ€ {U} â†’ U âˆˆ ğ’± â†’ Î£ W Î» vu â†’ Î£ W Î» cu â†’ Î£ ğ• Î» Zu
              â†’ R vu cu Ã— Zu âŠ† Râ»Â¹ x [ E ] Ã— S x cu Zu
             Ã— (âˆ€ ğ”¼' â†’ ğ”¼' âŠ† E â†’ Â¬ S vu cu ğ”¼')
          âˆˆğ’±â‡’ {U} h = case p h of
            Î» { (vu â¸´ cu â¸´ Zu â¸´ fst â¸´ snd â¸´ a1 â¸´ a2 â¸´ a3 â¸´ a4) â†’ vu â¸´ cu â¸´ Zu â¸´ a1 â¸´ (Î» {x â†’ a2 x}) â¸´
            a3 â¸´ a4}
          cáµ¤ : âˆ€ {U} â†’ U âˆˆ ğ’± â†’ W
          cáµ¤ u = case âˆˆğ’±â‡’ u of Î» { (vu â¸´ cu â¸´ zu â¸´ snd) â†’ cu}
     in
     (âˆ€ (w : W) â†’ (Î£ ğ• Î» U â†’ Î£ (U âˆˆ ğ’±) Î» Uâˆˆğ’± â†’ cáµ¤ Uâˆˆğ’± â‰¡ w)
      âŠ (âˆ€ {U} â†’ (Uâˆˆğ’± : U âˆˆ ğ’±) â†’ Â¬ (cáµ¤ Uâˆˆğ’± â‰¡ w)))

  âŠ©Râ‚â‡’Râ‚-condition : *âŠ©Râ‚ â†’ Â¬ Â¬Râ‚-condition
  âŠ©Râ‚â‡’Râ‚-condition Râ‚ (w â¸´ x â¸´ u â¸´ V â¸´ C â¸´ E â¸´ Rwx â¸´ Rxu â¸´ SwuV â¸´ (_ â¸´ choice) â¸´ EâŠ†Rx â¸´ p â¸´ t)
    = case âŠ©MP âŠ©r1 wâŠ©aâ–·b of Î» { s â†’ case (âŠ©â–· â‡’ s) Rwx (âŠ©âˆ§ â‡ (xâŠ©aâ—c â¸´ xâŠ©dâ–·â™¢e)) of
    Î» { (U â¸´ SwxU â¸´ UâŠ©bâˆ§â–¡câˆ§câ–·d) â†’
      let
        Uâˆˆğ’± : U âˆˆ ğ’±
        Uâˆˆğ’± = âˆˆğ’±' SwxU
                (Î» z â†’ projâ‚ (âŠ©âˆ§ â‡’ UâŠ©bâˆ§â–¡câˆ§câ–·d z))
                Î» z â†’ projâ‚ (âŠ©âˆ§ â‡’ projâ‚‚  (âŠ©âˆ§ â‡’ UâŠ©bâˆ§â–¡câˆ§câ–·d z))
        vuâˆˆU = projâ‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (p Uâˆˆğ’±))))
        Rvc = projâ‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (p Uâˆˆğ’±))))))
        Â¬Svcğ”¼ = projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (p Uâˆˆğ’±))))))))
      in
        case (âŠ©â–· â‡’ projâ‚‚ (âŠ©âˆ§ â‡’ (projâ‚‚ (âŠ©âˆ§ â‡’ UâŠ©bâˆ§â–¡câˆ§câ–·d vuâˆˆU)))) Rvc
          ([d] â‡ (U â¸´ Uâˆˆğ’± â¸´ refl)) of
          Î» { (ğ”¼' â¸´ Svcğ”¼' â¸´ ğ”¼'âŠ©E) â†’ Â¬Svcğ”¼ ğ”¼' (Î» {eâˆˆğ”¼' â†’ [e] â‡’ ğ”¼'âŠ©E eâˆˆğ”¼'}) Svcğ”¼'}}}
    where
    r1 : Fm
    r1 = (var a â–· var b) â† (((var a â— var c) âˆ§ var d â–· â™¢ var e)
      â–· (var b âˆ§ â–¡ var c âˆ§ (var d â–· var e)))
    ğ’± : Pred ğ• _
    ğ’± U = U âŠ† V Ã— S w x U Ã— R[ U ] âŠ† C
    Val : Valuation F
    Val i a = i â‰¡ u
    Val i b = i âˆˆ V
    Val i c = i âˆˆ C
    Val i e = i âˆˆ E
    Val i d with t i
    ... | injâ‚ x = âŠ¤
    ... | injâ‚‚ x = âŠ¥
    Val i (suc (suc (suc (suc (suc _))))) = âŠ¥
    M = model {V = Val} F
    âŠ©r1 : M , w âŠ© r1
    âŠ©r1 = Râ‚ Val w
    âˆˆğ’± : âˆ€ {U} â†’ U âˆˆ ğ’± â†’ Î£ W Î» vu â†’ Î£ W Î» cu â†’ Î£ ğ• Î» Zu
      â†’ R vu cu Ã— Zu âŠ† Râ»Â¹ x [ E ] Ã— S x cu Zu
      Ã— (âˆ€ ğ”¼' â†’ ğ”¼' âŠ† E â†’ Â¬ S vu cu ğ”¼')
    âˆˆğ’± {U} h with p h
    ... | (vu â¸´ cu â¸´ zu â¸´ fst â¸´ snd â¸´ a1 â¸´ a2 â¸´ a3) = vu â¸´ cu â¸´ zu â¸´ a1 â¸´ a2 â¸´ a3
    váµ¤ : âˆ€ {U} â†’ U âˆˆ ğ’± â†’ W
    váµ¤ u = projâ‚ (âˆˆğ’± u)
    cáµ¤ : âˆ€ {U} â†’ U âˆˆ ğ’± â†’ W
    cáµ¤ u = projâ‚ (projâ‚‚ (âˆˆğ’± u))
    Záµ¤ : âˆ€ {U} â†’ U âˆˆ ğ’± â†’ ğ•
    Záµ¤ u = projâ‚ (projâ‚‚ (projâ‚‚ (âˆˆğ’± u)))
    Rváµ¤cáµ¤ : âˆ€ {U} â†’ (Uâˆˆğ’± : U âˆˆ ğ’±) â†’ R (váµ¤ Uâˆˆğ’±) (cáµ¤ Uâˆˆğ’±)
    Rváµ¤cáµ¤ p = projâ‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (âˆˆğ’± p))))
    ZuâŠ†Râ»Â¹â‚“[E] : âˆ€ {U} â†’ (Uâˆˆğ’± : U âˆˆ ğ’±) â†’ Záµ¤ Uâˆˆğ’± âŠ† Râ»Â¹ x [ E ]
    ZuâŠ†Râ»Â¹â‚“[E] Uâˆˆğ’± = projâ‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (âˆˆğ’± Uâˆˆğ’±)))))
    Sxcáµ¤Záµ¤ : âˆ€ {U} â†’ (Uâˆˆğ’± : U âˆˆ ğ’±) â†’ S x (cáµ¤ Uâˆˆğ’±) (Záµ¤ Uâˆˆğ’±)
    Sxcáµ¤Záµ¤ Uâˆˆğ’± = projâ‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (projâ‚‚ (âˆˆğ’± Uâˆˆğ’±))))))
    open Extended (dec Val) âˆˆS? âˆˆSV?
    [a] : âˆ€ {y} â†’ M , y âŠ© var a â‡” y â‰¡ u
    [a] = equivalence (Î» {(var x) â†’ x}) (Î» xâ‚ â†’ var xâ‚)
    [b] : âˆ€ {y} â†’ M , y âŠ© var b â‡” y âˆˆ V
    [b] = equivalence (Î» {(var z) â†’ z}) Î» xâ‚ â†’ var xâ‚
    [c] : âˆ€ {y} â†’ M , y âŠ© var c â‡” y âˆˆ C
    [c] = equivalence (Î» {(var z) â†’ z}) Î» xâ‚ â†’ var xâ‚
    [e] : âˆ€ {y} â†’ M , y âŠ© var e â‡” y âˆˆ E
    [e] = equivalence (Î» {(var z) â†’ z}) Î» xâ‚ â†’ var xâ‚
    [d] : âˆ€ {y} â†’ M , y âŠ© var d â‡” Î£ ğ• Î» U â†’ Î£ (U âˆˆ ğ’±) Î» Uâˆˆğ’± â†’ cáµ¤ Uâˆˆğ’± â‰¡ y
    [d] {y} = equivalence â‡¨ Î» xâ‚ â†’ var (â‡¦ xâ‚)
      where
      â‡¨ : M , y âŠ© var d â†’ Î£ ğ• (Î» U â†’ Î£ (U âˆˆ ğ’±) (Î» Uâˆˆğ’± â†’ cáµ¤ Uâˆˆğ’± â‰¡ y))
      â‡¨ (var x) with t y
      ... | injâ‚ xâ‚ = xâ‚
      â‡¦ : Î£ ğ• (Î» U â†’ Î£ (U âˆˆ ğ’±) (Î» Uâˆˆğ’± â†’ cáµ¤ Uâˆˆğ’± â‰¡ y)) â†’ d âˆˆ Val y
      â‡¦ x with t y
      ... | injâ‚ xâ‚ = tt
      â‡¦ (U â¸´ Uâˆˆğ’± â¸´ ref) | injâ‚‚ r = case r Uâˆˆğ’± of Î» {z â†’ z ref}
    wâŠ©aâ–·b : M , w âŠ© var a â–· var b
    wâŠ©aâ–·b = âŠ©â–· â‡ Î» { {y} Rwy ya â†’ case [a] â‡’ ya of Î» { refl â†’ V â¸´ SwuV â¸´ Î» {x â†’ [b] â‡ x}}}
    xâŠ©aâ—c : M , x âŠ© var a â— var c
    xâŠ©aâ—c = âŠ©Â¬ â‡ (âŠ®â–· â‡ (u â¸´ (Rxu â¸´ ([a] â‡ refl â¸´ Î» {Y (s â¸´ sâˆˆY) SxuY â†’
      case choice SxuY of Î» { (c' â¸´ câˆˆY â¸´ câˆˆC) â†’ c' â¸´ (câˆˆY â¸´ âŠ®Â¬ â‡ ([c] â‡ câˆˆC))}}))))
    ğ’±âŠ©b : âˆ€ {U} â†’ U âˆˆ ğ’± â†’ U âŠ† (M ,_âŠ© var b)
    ğ’±âŠ©b {U} (UâŠ†V â¸´ _) {u'} u'âˆˆU = [b] â‡ UâŠ†V u'âˆˆU
    ğ’±âŠ©â–¡c : âˆ€ {U} â†’ U âˆˆ ğ’± â†’ U âŠ† M ,_âŠ© â–¡ var c
    ğ’±âŠ©â–¡c {U} (_ â¸´ _ â¸´ R[U]âŠ†C) {u'} u'âˆˆU = âŠ©â–¡ â‡ Î» { {z} Ru'z â†’ [c] â‡ R[U]âŠ†C (u' â¸´ u'âˆˆU â¸´ Ru'z)}
    âˆˆğ’±' : âˆ€ {U} â†’ S w x U â†’ U âŠ† M ,_âŠ© var b â†’ U âŠ† M ,_âŠ© â–¡ var c â†’ U âˆˆ ğ’±
    âˆˆğ’±' {U} SwxU Ub Uâ–¡c = (Î» z â†’ [b] â‡’ (Ub z)) â¸´ SwxU â¸´ Î» { (c' â¸´ c'âˆˆU â¸´ Rcy)
      â†’ [c] â‡’ (âŠ©â–¡ â‡’ Uâ–¡c c'âˆˆU) Rcy}
    xâŠ©dâ–·â™¢e : M , x âŠ© var d â–· â™¢ (var e)
    xâŠ©dâ–·â™¢e = âŠ©â–· â‡ Î» { {y} Rxy yâŠ©d â†’ case [d] â‡’ yâŠ©d of
      Î» { (U â¸´ Uâˆˆğ’± â¸´ refl) â†’ Záµ¤ Uâˆˆğ’± â¸´ Sxcáµ¤Záµ¤ Uâˆˆğ’± â¸´
       Î» { âˆˆZáµ¤ â†’ case ZuâŠ†Râ»Â¹â‚“[E] Uâˆˆğ’± âˆˆZáµ¤ of Î» { ((e' â¸´ e'âˆˆE â¸´ Rye) â¸´ Rxe') â†’ âŠ©â™¢ â‡ (e' â¸´ Rye â¸´ [e] â‡ e'âˆˆE)}} }}

\end{spverbatim}
